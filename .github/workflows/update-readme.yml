name: Update README
on:
  push:
    branches: [main]

permissions:
  contents: write 

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Anthropic SDK
        run: pip install anthropic
      
      - name: Update README with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'EOF'
          import anthropic
          import subprocess
          import os

          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

          # Get recent changes
          diff = subprocess.run(['git', 'diff', 'HEAD~1'], capture_output=True, text=True).stdout

          # Get project file tree (excluding common ignore patterns)
          tree = subprocess.run(
              ['find', '.', '-type', 'f', 
              '!', '-path', '*/.*',
              '!', '-path', '*/node_modules/*',
              '!', '-path', '*/.gpu/*',
              '!', '-path', '*/__pycache__/*',
              '!', '-path', '*/build/*',
              '!', '-path', '*/dist/*'],
              capture_output=True, text=True
          ).stdout

          # Get current README
          with open('README.md', 'r') as f:
              readme = f.read()

          # Ask Claude to update it
          message = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=4096,
              messages=[{
                  "role": "user",
                  "content": f"""Your job is to make sure the current README aligns with the actual state of the project.
          The project is in active development with new commits being made regularly.  But remember, you are a professional,
          and you don't use any emojis.

          First, here's the project file structure:
          {tree}

          Recent changes committed:
          {diff}

          Current README:
          {readme}

          Review the project structure and recent changes. Update README.md to reflect any new features, API changes, dependencies, or setup instructions. Maintain existing structure and tone. Do not update if changes are insignificant.

          Output ONLY the updated README content, nothing else."""
              }]
          )

          # Write updated README
          with open('README.md', 'w') as f:
              f.write(message.content[0].text)
          EOF
      
      - name: Generate commit message
        id: commit_msg
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if git diff --quiet README.md; then
            echo "message=docs: no README updates needed" >> $GITHUB_OUTPUT
          else
            MSG=$(python3 << 'EOF'
          import anthropic
          import subprocess
          import os
          
          client = anthropic.Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          diff = subprocess.run(['git', 'diff', 'README.md'], capture_output=True, text=True).stdout
          
          message = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=100,
              messages=[{
                  "role": "user",
                  "content": f"Based on this README diff, generate a single-line commit message (max 72 chars) starting with 'docs: '. Output ONLY the message:\n\n{diff}"
              }]
          )
          
          print(message.content[0].text.strip())
          EOF
          )
            echo "message=$MSG" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git commit -m "${{ steps.commit_msg.outputs.message }}" || echo "No changes"
          git push